{% extends "base.html" %}
{% block title %}Analyze Audio - AI-Powered Scam Call Identification Tool{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-black to-gray-900">
    {% include 'includes/nav.html' %}
    
    <div class="max-w-2xl mx-auto p-6">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">Analyze Audio Recording</h1>
            <p class="text-gray-400">Upload audio files for scam detection</p>
        </div>

        <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-8 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.8)]">
            <!-- Quick Text Test -->
            <div class="mb-6 bg-gray-800 border border-gray-600 rounded-xl p-4">
                <p class="text-white font-semibold mb-3">Text Analysis</p>
                <div class="flex gap-2">
                    <input type="text" id="quickTestText" class="flex-1 px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white" placeholder="Enter text to analyze...">
                    <button onclick="testText()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold">
                        Test
                    </button>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div id="uploadArea" class="border-2 border-dashed border-gray-700 rounded-xl p-12 text-center hover:border-red-500 transition-colors">
                <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                </svg>
                <p class="text-white mb-2">Drag and drop audio/video file here</p>
                <p class="text-gray-400 text-sm mb-4">Supports: MP3, WAV, OGG, MP4, AVI</p>
                <input type="file" id="audioFile" accept="audio/*,video/*" class="hidden" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('audioFile').click()" class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg text-white font-semibold">
                    Choose File
                </button>
                <p id="fileName" class="text-gray-400 text-sm mt-4"></p>
            </div>

            <!-- Analysis Result -->
            <div id="analysisResult" class="hidden mt-8 space-y-4">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Analysis Result</h3>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-400 mb-2">Risk Level:</p>
                        <span id="riskLevel" class="px-4 py-2 rounded-lg text-white font-semibold">Loading...</span>
                    </div>

                    <div class="mb-4">
                        <p class="text-sm text-gray-400 mb-2">Fraud Score:</p>
                        <div class="w-full bg-gray-800 rounded-full h-3">
                            <div id="scoreBar" class="bg-red-600 h-3 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="scoreText" class="text-gray-400 text-sm mt-2">0%</p>
                    </div>

                    <div id="threats" class="mb-4">
                        <!-- Threats displayed here -->
                    </div>

                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                        <p class="text-sm text-gray-400 mb-2">Transcription:</p>
                        <p id="transcription" class="text-white text-sm">...</p>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden mt-8 text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-red-600"></div>
                <p class="text-gray-400 mt-4">Analyzing audio...</p>
            </div>
        </div>
    </div>
</div>

<script>
async function testText() {
    const text = document.getElementById('quickTestText').value;
    if (!text) return;
    
    const loadingState = document.getElementById('loadingState');
    const analysisResult = document.getElementById('analysisResult');
    
    loadingState.classList.remove('hidden');
    analysisResult.classList.add('hidden');
    
    try {
        const response = await fetch('/api/analyze-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        });
        
        const result = await response.json();
        
        loadingState.classList.add('hidden');
        analysisResult.classList.remove('hidden');
        
        // Display results
        displayResults(result);
    } catch (error) {
        console.error('Error:', error);
        loadingState.classList.add('hidden');
        alert('Error analyzing text. Please try again.');
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    document.getElementById('fileName').textContent = `Selected: ${file.name}`;
    document.getElementById('fileName').classList.remove('hidden');
    
    // Upload and analyze
    uploadAndAnalyze(file);
}

async function uploadAndAnalyze(file) {
    const loadingState = document.getElementById('loadingState');
    const analysisResult = document.getElementById('analysisResult');
    
    loadingState.classList.remove('hidden');
    analysisResult.classList.add('hidden');
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/analyze-audio', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        loadingState.classList.add('hidden');
        analysisResult.classList.remove('hidden');
        
        // Display results
        displayResults(result);
    } catch (error) {
        console.error('Error:', error);
        loadingState.classList.add('hidden');
        alert('Error analyzing audio file. Please try again.');
    }
}


function displayResults(result) {
    const riskLevel = document.getElementById('riskLevel');
    const scoreBar = document.getElementById('scoreBar');
    const scoreText = document.getElementById('scoreText');
    const threats = document.getElementById('threats');
    const transcription = document.getElementById('transcription');
    
    const score = result.scam_score * 100;
    
    // Use backend's risk_level
    const risk_level = result.risk_level || 'safe';
    
    if (risk_level === 'critical') {
        riskLevel.textContent = 'ðŸ”´ CRITICAL';
        riskLevel.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-red-600';
    } else if (risk_level === 'warning') {
        riskLevel.textContent = 'ðŸŸ¡ WARNING';
        riskLevel.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-yellow-600';
    } else {
        riskLevel.textContent = 'ðŸŸ¢ SAFE';
        riskLevel.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-green-600';
    }
    
    // Score bar
    scoreBar.style.width = `${score}%`;
    if (score > 60) scoreBar.className = 'bg-red-600 h-3 rounded-full';
    else if (score > 30) scoreBar.className = 'bg-yellow-600 h-3 rounded-full';
    else scoreBar.className = 'bg-green-600 h-3 rounded-full';
    
    scoreText.textContent = `${score.toFixed(1)}%`;
    
    // Threats
    if (result.reasons && result.reasons.length > 0) {
        threats.innerHTML = `
            <p class="text-sm text-gray-400 mb-2">Detected Threats:</p>
            <div class="space-y-2">
                ${result.reasons.map(reason => `
                    <div class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white">
                        ${reason}
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    // Transcription
    transcription.textContent = result.transcription || 'No transcription available';
}
</script>

{% endblock %}

