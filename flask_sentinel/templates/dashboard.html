{% extends "base.html" %}
{% block title %}Dashboard - AI-Powered Scam Call Identification Tool{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="min-h-screen bg-gradient-to-b from-black to-gray-900 p-6">
    {% include 'includes/nav.html' %}
    
    <div class="max-w-6xl mx-auto space-y-6">
        <!-- Header -->
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white">AI-Powered Scam Call Identification Tool</h1>
                <p class="text-gray-400">Real-time call protection</p>
            </div>
            <a href="/dialer" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all flex items-center gap-2 shadow-[0_0_20px_rgba(239,68,68,0.5)]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                Make Call
            </a>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="statsGrid">
            <!-- Stats loaded dynamically -->
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Duration Chart -->
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-4 lg:col-span-2 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.8)]">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-white">Recent Call Durations</h3>
                    </div>
                    <span class="text-xs text-gray-400">Last 10 calls</span>
                </div>
                <div class="h-56">
                    <canvas id="durationChart"></canvas>
                </div>
            </div>

            <!-- Risk Chart -->
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-4 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.8)]">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-white">Risk Breakdown</h3>
                </div>
                <div class="h-56">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="/contacts" class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-6 hover:shadow-[0_0_20px_rgba(239,68,68,0.5)] transition-all cursor-pointer">
                <h3 class="text-xl font-semibold text-white mb-2">Contacts</h3>
                <p class="text-gray-400">View and manage your contacts with scam risk indicators</p>
            </a>
            <a href="/history" class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-6 hover:shadow-[0_0_20px_rgba(239,68,68,0.5)] transition-all cursor-pointer">
                <h3 class="text-xl font-semibold text-white mb-2">Call History</h3>
                <p class="text-gray-400">Review past calls and scam detections</p>
            </a>
            <a href="/recorder" class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-6 hover:shadow-[0_0_20px_rgba(239,68,68,0.5)] transition-all cursor-pointer">
                <h3 class="text-xl font-semibold text-white mb-2">Analyze Recording</h3>
                <p class="text-gray-400">Upload and analyze audio files for scam detection</p>
            </a>
        </div>
    </div>
</div>

<script>
async function loadDashboard() {
    try {
        const statsRes = await fetch('/api/statistics');
        const statsData = await statsRes.json();
        const stats = statsData.data[0] || {total_calls: 0, scam_calls_blocked: 0, warning_calls: 0, safe_calls: 0};
        
        // Calculate stats from actual calls data
        const callsRes = await fetch('/api/calls?limit=1000');
        const callsData = await callsRes.json();
        const allCalls = callsData.data || [];
        
        let totalCalls = allCalls.length;
        let warningCalls = allCalls.filter(c => c.scam_risk_level === 'warning' || c.scam_risk_level === 'critical').length;
        let safeCalls = allCalls.filter(c => c.scam_risk_level === 'safe' || !c.scam_risk_level || c.scam_risk_level === null).length;
        
        // Update stats grid
        document.getElementById('statsGrid').innerHTML = `
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-6 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.8)]">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Total Calls</p>
                        <p class="text-3xl font-bold text-white mt-2">${totalCalls}</p>
                    </div>
                    <svg class="h-10 w-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                </div>
            </div>
            <div class="bg-gradient-to-br from-yellow-900/50 to-yellow-800/50 border border-yellow-700/50 rounded-xl p-6 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.8)]">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-300">Warnings</p>
                        <p class="text-3xl font-bold text-white mt-2">${warningCalls}</p>
                    </div>
                    <svg class="w-10 h-10 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-900/50 to-green-800/50 border border-green-700/50 rounded-xl p-6 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.8)]">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-300">Safe Calls</p>
                        <p class="text-3xl font-bold text-white mt-2">${safeCalls}</p>
                    </div>
                    <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
            </div>
        `;
        
        createDurationChart(allCalls.slice(0, 10));
        createRiskChart(allCalls);
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

function createDurationChart(calls) {
    const ctx = document.getElementById('durationChart').getContext('2d');
    const recentCalls = calls.slice(-10).reverse().map(c => ({
        time: new Date(c.started_at).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }),
        duration: c.duration || 0
    }));
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: recentCalls.map(c => c.time),
            datasets: [{
                label: 'Duration (s)',
                data: recentCalls.map(c => c.duration),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { ticks: { color: '#aaa' }, grid: { color: '#333' } },
                y: { ticks: { color: '#aaa' }, grid: { color: '#333' } }
            }
        }
    });
}

function createRiskChart(calls) {
    const ctx = document.getElementById('riskChart').getContext('2d');
    const counts = { safe: 0, warning: 0, critical: 0 };
    calls.forEach(c => {
        const level = c.scam_risk_level || "safe";
        if (counts[level] !== undefined) counts[level]++;
    });
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Safe', 'Warning', 'Critical'],
            datasets: [{
                data: [counts.safe || 0, counts.warning || 0, counts.critical || 0],
                backgroundColor: ['#22c55e', '#f59e0b', '#ef4444']
            }]
        },
        options: {
            plugins: { legend: { labels: { color: '#fff' } } },
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

loadDashboard();
</script>

{% endblock %}
